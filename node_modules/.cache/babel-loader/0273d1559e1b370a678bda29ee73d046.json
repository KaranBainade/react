{"ast":null,"code":"import { __assign, __extends, __rest } from \"tslib\";\nimport React, { PureComponent } from 'react';\nimport { createPortal } from 'react-dom';\nimport Select from 'react-select';\nimport createFocusTrap from 'focus-trap';\nimport { Manager, Reference, Popper } from 'react-popper';\nimport NodeResolver from 'react-node-resolver';\nimport shallowEqualObjects from 'shallow-equal/objects';\nimport { N80 } from '@atlaskit/theme/colors';\nimport { MenuDialog, DummyControl, defaultComponents } from './components';\n/** Are we rendering on the client or server? */\n\nvar canUseDOM = function () {\n  return Boolean(typeof window !== 'undefined' && window.document && window.document.createElement);\n}; // ==============================\n// Class\n// ==============================\n\n\nvar defaultStyles = {\n  groupHeading: function (provided) {\n    return __assign(__assign({}, provided), {\n      color: N80\n    });\n  }\n};\nvar defaultPopperProps = {\n  modifiers: {\n    offset: {\n      offset: \"0, 8\"\n    }\n  },\n  placement: 'bottom-start'\n};\n\nvar isEmpty = function (obj) {\n  return Object.keys(obj).length === 0;\n};\n\nvar PopupSelect =\n/** @class */\nfunction (_super) {\n  __extends(PopupSelect, _super);\n\n  function PopupSelect() {\n    var _this = _super !== null && _super.apply(this, arguments) || this;\n\n    _this.focusTrap = null;\n    _this.menuRef = null;\n    _this.selectRef = null;\n    _this.targetRef = null;\n    _this.state = {\n      isOpen: false,\n      mergedComponents: defaultComponents,\n      mergedPopperProps: defaultPopperProps\n    }; // Event Handlers\n    // ==============================\n\n    _this.handleKeyDown = function (event) {\n      switch (event.key) {\n        case 'Escape':\n        case 'Esc':\n          _this.close();\n\n          break;\n\n        default:\n      }\n\n      if (_this.props.handleKeyDown) {\n        _this.props.handleKeyDown(event);\n      }\n    };\n\n    _this.handleClick = function (_a) {\n      var target = _a.target;\n      var isOpen = _this.state.isOpen; // appease flow\n\n      if (!(target instanceof Element)) return; // NOTE: Why not use the <Blanket /> component to close?\n      // We don't want to interupt the user's flow. Taking this approach allows\n      // user to click \"through\" to other elements and close the popout.\n\n      if (isOpen && _this.menuRef && !_this.menuRef.contains(target)) {\n        _this.close();\n      } // open on target click -- we can't trust consumers to spread the onClick\n      // property to the target\n\n\n      if (!isOpen && _this.targetRef && _this.targetRef.contains(target)) {\n        _this.open();\n      }\n    };\n\n    _this.handleSelectChange = function (value, actionMeta) {\n      var _a = _this.props,\n          closeMenuOnSelect = _a.closeMenuOnSelect,\n          onChange = _a.onChange;\n      if (closeMenuOnSelect && actionMeta.action !== 'clear') _this.close();\n      if (onChange) onChange(value, actionMeta);\n    }; // Internal Lifecycle\n    // ==============================\n\n\n    _this.open = function () {\n      var onOpen = _this.props.onOpen;\n      if (onOpen) onOpen();\n\n      _this.setState({\n        isOpen: true\n      }, _this.initialiseFocusTrap);\n\n      if (_this.selectRef) {\n        _this.selectRef.select.openMenu('first'); // HACK\n\n      }\n\n      if (typeof window === 'undefined') return;\n      window.addEventListener('keydown', _this.handleKeyDown);\n    };\n\n    _this.initialiseFocusTrap = function () {\n      if (!_this.menuRef) return;\n      var trapConfig = {\n        clickOutsideDeactivates: true,\n        escapeDeactivates: true,\n        fallbackFocus: _this.menuRef,\n        returnFocusOnDeactivate: true\n      };\n      _this.focusTrap = createFocusTrap(_this.menuRef, trapConfig); // allow time for the HTMLElement to render\n\n      setTimeout(function () {\n        return _this.focusTrap.activate();\n      }, 1);\n    };\n\n    _this.close = function () {\n      var onClose = _this.props.onClose;\n      if (onClose) onClose();\n\n      _this.setState({\n        isOpen: false\n      });\n\n      if (_this.focusTrap) {\n        _this.focusTrap.deactivate();\n      }\n\n      if (typeof window === 'undefined') return;\n      window.removeEventListener('keydown', _this.handleKeyDown);\n    }; // Refs\n    // ==============================\n\n\n    _this.resolveTargetRef = function (popperRef) {\n      return function (ref) {\n        // avoid thrashing fn calls\n        if (!_this.targetRef && popperRef && ref) {\n          _this.targetRef = ref;\n\n          if (typeof popperRef === 'function') {\n            popperRef(ref);\n          } else {\n            popperRef.current = ref;\n          }\n        }\n      };\n    };\n\n    _this.resolveMenuRef = function (popperRef) {\n      return function (ref) {\n        _this.menuRef = ref;\n\n        if (typeof popperRef === 'function') {\n          popperRef(ref);\n        } else {\n          popperRef.current = ref;\n        }\n      };\n    };\n\n    _this.getSelectRef = function (ref) {\n      _this.selectRef = ref;\n    }; // Utils\n    // ==============================\n    // account for groups when counting options\n    // this may need to be recursive, right now it just counts one level\n\n\n    _this.getItemCount = function () {\n      var options = _this.props.options;\n      var count = 0;\n      options.forEach(function (groupOrOption) {\n        if (groupOrOption.options) {\n          groupOrOption.options.forEach(function () {\n            return count++;\n          });\n        } else {\n          count++;\n        }\n      });\n      return count;\n    };\n\n    _this.getMaxHeight = function () {\n      var maxMenuHeight = _this.props.maxMenuHeight;\n      if (!_this.selectRef) return maxMenuHeight; // subtract the control height to maintain consistency\n\n      var showSearchControl = _this.showSearchControl();\n\n      var controlRef = _this.selectRef.select.controlRef; // @ts-ignore React-select provides incomplete types for controlRef\n\n      var offsetHeight = showSearchControl ? controlRef.offsetHeight : 0;\n      var maxHeight = maxMenuHeight - offsetHeight;\n      return maxHeight;\n    }; // if the threshold is exceeded display the search control\n\n\n    _this.showSearchControl = function () {\n      var searchThreshold = _this.props.searchThreshold;\n      return _this.getItemCount() > searchThreshold;\n    }; // Renderers\n    // ==============================\n\n\n    _this.renderSelect = function () {\n      var _a = _this.props,\n          footer = _a.footer,\n          maxMenuWidth = _a.maxMenuWidth,\n          minMenuWidth = _a.minMenuWidth,\n          target = _a.target,\n          props = __rest(_a, [\"footer\", \"maxMenuWidth\", \"minMenuWidth\", \"target\"]);\n\n      var _b = _this.state,\n          isOpen = _b.isOpen,\n          mergedComponents = _b.mergedComponents,\n          mergedPopperProps = _b.mergedPopperProps;\n\n      var showSearchControl = _this.showSearchControl();\n\n      var portalDestination = canUseDOM() ? document.body : null;\n\n      var components = __assign(__assign({}, mergedComponents), {\n        Control: showSearchControl ? mergedComponents.Control : DummyControl\n      });\n\n      if (!portalDestination || !isOpen) return null;\n      var popper = React.createElement(Popper, __assign({}, mergedPopperProps), function (_a) {\n        var placement = _a.placement,\n            ref = _a.ref,\n            style = _a.style;\n        return React.createElement(NodeResolver, {\n          innerRef: _this.resolveMenuRef(ref)\n        }, React.createElement(MenuDialog, {\n          style: style,\n          \"data-placement\": placement,\n          minWidth: minMenuWidth,\n          maxWidth: maxMenuWidth\n        }, React.createElement(Select, __assign({\n          backspaceRemovesValue: false,\n          controlShouldRenderValue: false,\n          isClearable: false,\n          tabSelectsValue: false,\n          menuIsOpen: true,\n          ref: _this.getSelectRef\n        }, props, {\n          isSearchable: showSearchControl,\n          styles: __assign(__assign({}, defaultStyles), props.styles),\n          maxMenuHeight: _this.getMaxHeight(),\n          components: components,\n          onChange: _this.handleSelectChange\n        })), footer));\n      });\n      return mergedPopperProps.positionFixed ? popper : createPortal(popper, portalDestination);\n    };\n\n    return _this;\n  }\n\n  PopupSelect.getDerivedStateFromProps = function (props, state) {\n    var newState = {}; // Merge consumer and default popper props\n\n    var mergedPopperProps = __assign(__assign({}, defaultPopperProps), props.popperProps);\n\n    if (!shallowEqualObjects(mergedPopperProps, state.mergedPopperProps)) {\n      newState.mergedPopperProps = mergedPopperProps;\n    } // Merge consumer and default components\n\n\n    var mergedComponents = __assign(__assign({}, defaultComponents), props.components);\n\n    if (!shallowEqualObjects(mergedComponents, state.mergedComponents)) {\n      newState.mergedComponents = mergedComponents;\n    }\n\n    if (!isEmpty(newState)) return newState;\n    return null;\n  };\n\n  PopupSelect.prototype.componentDidMount = function () {\n    if (typeof window === 'undefined') return;\n    window.addEventListener('click', this.handleClick);\n  };\n\n  PopupSelect.prototype.componentWillUnmount = function () {\n    if (typeof window === 'undefined') return;\n    window.removeEventListener('click', this.handleClick);\n    window.removeEventListener('keydown', this.handleKeyDown);\n  };\n\n  PopupSelect.prototype.render = function () {\n    var _this = this;\n\n    var target = this.props.target;\n    var isOpen = this.state.isOpen;\n    return React.createElement(Manager, null, React.createElement(Reference, null, function (_a) {\n      var ref = _a.ref;\n      return target && target({\n        ref: _this.resolveTargetRef(ref),\n        isOpen: isOpen\n      });\n    }), this.renderSelect());\n  };\n\n  PopupSelect.defaultProps = {\n    closeMenuOnSelect: true,\n    components: {},\n    maxMenuHeight: 300,\n    maxMenuWidth: 440,\n    minMenuWidth: 220,\n    popperProps: {},\n    searchThreshold: 5,\n    styles: {},\n    options: []\n  };\n  return PopupSelect;\n}(PureComponent);\n\nexport default PopupSelect;","map":{"version":3,"sources":["../../../src/PopupSelect/PopupSelect.tsx"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["import { __assign, __extends, __rest } from \"tslib\";\nimport React, { PureComponent } from 'react';\nimport { createPortal } from 'react-dom';\nimport Select from 'react-select';\nimport createFocusTrap from 'focus-trap';\nimport { Manager, Reference, Popper } from 'react-popper';\nimport NodeResolver from 'react-node-resolver';\nimport shallowEqualObjects from 'shallow-equal/objects';\nimport { N80 } from '@atlaskit/theme/colors';\nimport { MenuDialog, DummyControl, defaultComponents } from './components';\n/** Are we rendering on the client or server? */\nvar canUseDOM = function () {\n    return Boolean(typeof window !== 'undefined' &&\n        window.document &&\n        window.document.createElement);\n};\n// ==============================\n// Class\n// ==============================\nvar defaultStyles = {\n    groupHeading: function (provided) { return (__assign(__assign({}, provided), { color: N80 })); },\n};\nvar defaultPopperProps = {\n    modifiers: { offset: { offset: \"0, 8\" } },\n    placement: 'bottom-start',\n};\nvar isEmpty = function (obj) { return Object.keys(obj).length === 0; };\nvar PopupSelect = /** @class */ (function (_super) {\n    __extends(PopupSelect, _super);\n    function PopupSelect() {\n        var _this = _super !== null && _super.apply(this, arguments) || this;\n        _this.focusTrap = null;\n        _this.menuRef = null;\n        _this.selectRef = null;\n        _this.targetRef = null;\n        _this.state = {\n            isOpen: false,\n            mergedComponents: defaultComponents,\n            mergedPopperProps: defaultPopperProps,\n        };\n        // Event Handlers\n        // ==============================\n        _this.handleKeyDown = function (event) {\n            switch (event.key) {\n                case 'Escape':\n                case 'Esc':\n                    _this.close();\n                    break;\n                default:\n            }\n            if (_this.props.handleKeyDown) {\n                _this.props.handleKeyDown(event);\n            }\n        };\n        _this.handleClick = function (_a) {\n            var target = _a.target;\n            var isOpen = _this.state.isOpen;\n            // appease flow\n            if (!(target instanceof Element))\n                return;\n            // NOTE: Why not use the <Blanket /> component to close?\n            // We don't want to interupt the user's flow. Taking this approach allows\n            // user to click \"through\" to other elements and close the popout.\n            if (isOpen && _this.menuRef && !_this.menuRef.contains(target)) {\n                _this.close();\n            }\n            // open on target click -- we can't trust consumers to spread the onClick\n            // property to the target\n            if (!isOpen && _this.targetRef && _this.targetRef.contains(target)) {\n                _this.open();\n            }\n        };\n        _this.handleSelectChange = function (value, actionMeta) {\n            var _a = _this.props, closeMenuOnSelect = _a.closeMenuOnSelect, onChange = _a.onChange;\n            if (closeMenuOnSelect && actionMeta.action !== 'clear')\n                _this.close();\n            if (onChange)\n                onChange(value, actionMeta);\n        };\n        // Internal Lifecycle\n        // ==============================\n        _this.open = function () {\n            var onOpen = _this.props.onOpen;\n            if (onOpen)\n                onOpen();\n            _this.setState({ isOpen: true }, _this.initialiseFocusTrap);\n            if (_this.selectRef) {\n                _this.selectRef.select.openMenu('first'); // HACK\n            }\n            if (typeof window === 'undefined')\n                return;\n            window.addEventListener('keydown', _this.handleKeyDown);\n        };\n        _this.initialiseFocusTrap = function () {\n            if (!_this.menuRef)\n                return;\n            var trapConfig = {\n                clickOutsideDeactivates: true,\n                escapeDeactivates: true,\n                fallbackFocus: _this.menuRef,\n                returnFocusOnDeactivate: true,\n            };\n            _this.focusTrap = createFocusTrap(_this.menuRef, trapConfig);\n            // allow time for the HTMLElement to render\n            setTimeout(function () { return _this.focusTrap.activate(); }, 1);\n        };\n        _this.close = function () {\n            var onClose = _this.props.onClose;\n            if (onClose)\n                onClose();\n            _this.setState({ isOpen: false });\n            if (_this.focusTrap) {\n                _this.focusTrap.deactivate();\n            }\n            if (typeof window === 'undefined')\n                return;\n            window.removeEventListener('keydown', _this.handleKeyDown);\n        };\n        // Refs\n        // ==============================\n        _this.resolveTargetRef = function (popperRef) { return function (ref) {\n            // avoid thrashing fn calls\n            if (!_this.targetRef && popperRef && ref) {\n                _this.targetRef = ref;\n                if (typeof popperRef === 'function') {\n                    popperRef(ref);\n                }\n                else {\n                    popperRef.current = ref;\n                }\n            }\n        }; };\n        _this.resolveMenuRef = function (popperRef) { return function (ref) {\n            _this.menuRef = ref;\n            if (typeof popperRef === 'function') {\n                popperRef(ref);\n            }\n            else {\n                popperRef.current = ref;\n            }\n        }; };\n        _this.getSelectRef = function (ref) {\n            _this.selectRef = ref;\n        };\n        // Utils\n        // ==============================\n        // account for groups when counting options\n        // this may need to be recursive, right now it just counts one level\n        _this.getItemCount = function () {\n            var options = _this.props.options;\n            var count = 0;\n            options.forEach(function (groupOrOption) {\n                if (groupOrOption.options) {\n                    groupOrOption.options.forEach(function () { return count++; });\n                }\n                else {\n                    count++;\n                }\n            });\n            return count;\n        };\n        _this.getMaxHeight = function () {\n            var maxMenuHeight = _this.props.maxMenuHeight;\n            if (!_this.selectRef)\n                return maxMenuHeight;\n            // subtract the control height to maintain consistency\n            var showSearchControl = _this.showSearchControl();\n            var controlRef = _this.selectRef.select.controlRef;\n            // @ts-ignore React-select provides incomplete types for controlRef\n            var offsetHeight = showSearchControl ? controlRef.offsetHeight : 0;\n            var maxHeight = maxMenuHeight - offsetHeight;\n            return maxHeight;\n        };\n        // if the threshold is exceeded display the search control\n        _this.showSearchControl = function () {\n            var searchThreshold = _this.props.searchThreshold;\n            return _this.getItemCount() > searchThreshold;\n        };\n        // Renderers\n        // ==============================\n        _this.renderSelect = function () {\n            var _a = _this.props, footer = _a.footer, maxMenuWidth = _a.maxMenuWidth, minMenuWidth = _a.minMenuWidth, target = _a.target, props = __rest(_a, [\"footer\", \"maxMenuWidth\", \"minMenuWidth\", \"target\"]);\n            var _b = _this.state, isOpen = _b.isOpen, mergedComponents = _b.mergedComponents, mergedPopperProps = _b.mergedPopperProps;\n            var showSearchControl = _this.showSearchControl();\n            var portalDestination = canUseDOM() ? document.body : null;\n            var components = __assign(__assign({}, mergedComponents), { Control: showSearchControl ? mergedComponents.Control : DummyControl });\n            if (!portalDestination || !isOpen)\n                return null;\n            var popper = (React.createElement(Popper, __assign({}, mergedPopperProps), function (_a) {\n                var placement = _a.placement, ref = _a.ref, style = _a.style;\n                return (React.createElement(NodeResolver, { innerRef: _this.resolveMenuRef(ref) },\n                    React.createElement(MenuDialog, { style: style, \"data-placement\": placement, minWidth: minMenuWidth, maxWidth: maxMenuWidth },\n                        React.createElement(Select, __assign({ backspaceRemovesValue: false, controlShouldRenderValue: false, isClearable: false, tabSelectsValue: false, menuIsOpen: true, ref: _this.getSelectRef }, props, { isSearchable: showSearchControl, styles: __assign(__assign({}, defaultStyles), props.styles), maxMenuHeight: _this.getMaxHeight(), components: components, onChange: _this.handleSelectChange })),\n                        footer)));\n            }));\n            return mergedPopperProps.positionFixed\n                ? popper\n                : createPortal(popper, portalDestination);\n        };\n        return _this;\n    }\n    PopupSelect.getDerivedStateFromProps = function (props, state) {\n        var newState = {};\n        // Merge consumer and default popper props\n        var mergedPopperProps = __assign(__assign({}, defaultPopperProps), props.popperProps);\n        if (!shallowEqualObjects(mergedPopperProps, state.mergedPopperProps)) {\n            newState.mergedPopperProps = mergedPopperProps;\n        }\n        // Merge consumer and default components\n        var mergedComponents = __assign(__assign({}, defaultComponents), props.components);\n        if (!shallowEqualObjects(mergedComponents, state.mergedComponents)) {\n            newState.mergedComponents = mergedComponents;\n        }\n        if (!isEmpty(newState))\n            return newState;\n        return null;\n    };\n    PopupSelect.prototype.componentDidMount = function () {\n        if (typeof window === 'undefined')\n            return;\n        window.addEventListener('click', this.handleClick);\n    };\n    PopupSelect.prototype.componentWillUnmount = function () {\n        if (typeof window === 'undefined')\n            return;\n        window.removeEventListener('click', this.handleClick);\n        window.removeEventListener('keydown', this.handleKeyDown);\n    };\n    PopupSelect.prototype.render = function () {\n        var _this = this;\n        var target = this.props.target;\n        var isOpen = this.state.isOpen;\n        return (React.createElement(Manager, null,\n            React.createElement(Reference, null, function (_a) {\n                var ref = _a.ref;\n                return target && target({ ref: _this.resolveTargetRef(ref), isOpen: isOpen });\n            }),\n            this.renderSelect()));\n    };\n    PopupSelect.defaultProps = {\n        closeMenuOnSelect: true,\n        components: {},\n        maxMenuHeight: 300,\n        maxMenuWidth: 440,\n        minMenuWidth: 220,\n        popperProps: {},\n        searchThreshold: 5,\n        styles: {},\n        options: [],\n    };\n    return PopupSelect;\n}(PureComponent));\nexport default PopupSelect;\n//# sourceMappingURL=PopupSelect.js.map"]},"metadata":{},"sourceType":"module"}